x-resource-limits: &resource-limits
  mem_limit: ${CONTAINER_MEM_LIMIT:-512m}
  cpus: ${CONTAINER_CPU_LIMIT:-1.0}

services:
  jsonrpc-order:
    build:
      context: ../..
      dockerfile: protocols/jsonrpc/Dockerfile
    container_name: jsonrpc-order
    ports:
      - "8011:8011"
    env_file:
      - ../../.env.docker
    # Use gunicorn with aiohttp workers for production parity with uvicorn (4 workers)
    command: [
      "gunicorn", "protocols.jsonrpc.order_service:create_app()",
      "--worker-class", "aiohttp.GunicornWebWorker",
      "--workers", "4",
      "--bind", "0.0.0.0:8011"
    ]
    depends_on:
      - jsonrpc-payment
    networks:
      - benchmark-network
    labels:
      - "com.benchmark.service=order"
      - "com.benchmark.protocol=jsonrpc"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    <<: *resource-limits

  jsonrpc-payment:
    build:
      context: ../..
      dockerfile: protocols/jsonrpc/Dockerfile
    container_name: jsonrpc-payment
    ports:
      - "8012:8012"
    env_file:
      - ../../.env.docker
    # Use gunicorn with aiohttp workers for production parity with uvicorn (4 workers)
    command: [
      "gunicorn", "protocols.jsonrpc.payment_service:create_app()",
      "--worker-class", "aiohttp.GunicornWebWorker",
      "--workers", "4",
      "--bind", "0.0.0.0:8012"
    ]
    depends_on:
      - jsonrpc-notification
    networks:
      - benchmark-network
    labels:
      - "com.benchmark.service=payment"
      - "com.benchmark.protocol=jsonrpc"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8012/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    <<: *resource-limits

  jsonrpc-notification:
    build:
      context: ../..
      dockerfile: protocols/jsonrpc/Dockerfile
    container_name: jsonrpc-notification
    ports:
      - "8013:8013"
    env_file:
      - ../../.env.docker
    # Use gunicorn with aiohttp workers for production parity with uvicorn (4 workers)
    command: [
      "gunicorn", "protocols.jsonrpc.notification_service:create_app()",
      "--worker-class", "aiohttp.GunicornWebWorker",
      "--workers", "4",
      "--bind", "0.0.0.0:8013"
    ]
    networks:
      - benchmark-network
    labels:
      - "com.benchmark.service=notification"
      - "com.benchmark.protocol=jsonrpc"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8013/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    <<: *resource-limits